<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex - Sistema de Foco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #111827;
        }
        .tab-btn-active {
            border-color: #EF4444;
            color: #F9FAFB;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        #stats-list::-webkit-scrollbar, #subject-list::-webkit-scrollbar {
            width: 8px;
        }
        #stats-list::-webkit-scrollbar-track, #subject-list::-webkit-scrollbar-track {
            background: #1F2937;
        }
        #stats-list::-webkit-scrollbar-thumb, #subject-list::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 text-center relative">
            
            <!-- Botão de Configurações -->
            <div class="absolute top-4 right-4">
                <button id="settings-btn" class="text-gray-500 hover:text-white transition-colors p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>

            <!-- ABAS PRINCIPAIS -->
            <div class="mb-8 flex border-b border-gray-700">
                <button id="tab-timer" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 tab-btn-active">Foco</button>
                <button id="tab-stats" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Relatórios</button>
                <button id="tab-subjects" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Matérias</button>
            </div>

            <!-- VIEW DO TIMER -->
            <div id="timer-view">
                <div class="my-10">
                    <h1 id="time-display" class="text-7xl md:text-8xl font-bold tracking-widest">25:00</h1>
                </div>
                <button id="start-pause-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold text-xl py-4 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                    INICIAR FOCO
                </button>
            </div>

            <!-- VIEW DE ESTATÍSTICAS -->
            <div id="stats-view" class="hidden text-left">
                <h2 class="text-xl font-bold mb-4">Relatório de Foco</h2>
                <div>
                    <canvas id="study-chart"></canvas>
                </div>
                <div id="stats-list" class="mt-4 bg-gray-900 rounded-lg p-4 h-40 overflow-y-auto">
                    <!-- As estatísticas em texto serão inseridas aqui -->
                </div>
                 <div class="text-center mt-4">
                    <button id="clear-stats-btn" class="text-xs text-gray-600 hover:text-red-400 transition-colors">Limpar todos os dados</button>
                </div>
            </div>

            <!-- VIEW DE MATÉRIAS -->
            <div id="subjects-view" class="hidden text-left">
                 <h2 class="text-xl font-bold mb-4">Gerenciar Matérias</h2>
                 <div class="flex gap-2 mb-4">
                     <input type="text" id="new-subject-input" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Nova matéria...">
                     <button id="add-subject-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">+</button>
                 </div>
                 <div id="subject-list" class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto">
                    <!-- Lista de matérias cadastradas -->
                 </div>
            </div>

        </div>
        <p class="text-center text-gray-500 mt-6 text-sm">Cortex Productivity System v1.1</p>
    </div>

    <!-- MODAL PARA SELECIONAR MATÉRIA -->
    <div id="subject-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-white">Definir Foco</h2>
            <div>
                <label for="subject-select" class="block mb-2 text-sm font-medium text-gray-400">Qual será a matéria estudada?</label>
                <select id="subject-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5">
                    <!-- Opções de matéria serão inseridas aqui -->
                </select>
            </div>
            <div class="flex justify-end mt-8">
                <button id="cancel-focus-btn" class="text-gray-400 hover:text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                <button id="start-focus-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Iniciar Foco</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIGURAÇÕES -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-white">Configurações de Tempo</h2>
            <div class="space-y-4">
                <div>
                    <label for="pomodoro-input" class="block mb-1 text-sm font-medium text-gray-400">Foco (minutos)</label>
                    <input type="number" id="pomodoro-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" min="1">
                </div>
                <div>
                    <label for="short-break-input" class="block mb-1 text-sm font-medium text-gray-400">Pausa (minutos)</label>
                    <input type="number" id="short-break-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" min="1">
                </div>
                <div>
                    <label for="long-break-input" class="block mb-1 text-sm font-medium text-gray-400">Descanso (minutos)</label>
                    <input type="number" id="long-break-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" min="1">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="close-settings-btn" class="text-gray-400 hover:text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="save-settings-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DA DOM ---
            const timeDisplay = document.getElementById('time-display');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const tabs = document.querySelectorAll('.tab-btn');
            const views = {
                timer: document.getElementById('timer-view'),
                stats: document.getElementById('stats-view'),
                subjects: document.getElementById('subjects-view')
            };
            const subjectModal = document.getElementById('subject-modal');
            const subjectSelect = document.getElementById('subject-select');
            const startFocusBtn = document.getElementById('start-focus-btn');
            const cancelFocusBtn = document.getElementById('cancel-focus-btn');
            const newSubjectInput = document.getElementById('new-subject-input');
            const addSubjectBtn = document.getElementById('add-subject-btn');
            const subjectList = document.getElementById('subject-list');
            const statsList = document.getElementById('stats-list');
            const clearStatsBtn = document.getElementById('clear-stats-btn');
            const chartCanvas = document.getElementById('study-chart');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const pomodoroInput = document.getElementById('pomodoro-input');
            const shortBreakInput = document.getElementById('short-break-input');
            const longBreakInput = document.getElementById('long-break-input');
            
            // --- ESTADO DA APLICAÇÃO ---
            let timerInterval;
            let timeLeft;
            let isRunning = false;
            let currentSubject = '';
            let sessions = [];
            let subjects = [];
            let studyChart;
            let timeSettings = { pomodoro: 25, shortBreak: 5, longBreak: 15 };

            // --- FUNÇÕES DE NAVEGAÇÃO ---
            function switchTab(tabId) {
                Object.values(views).forEach(view => view.classList.add('hidden'));
                tabs.forEach(tab => tab.classList.remove('tab-btn-active'));
                
                views[tabId].classList.remove('hidden');
                document.getElementById(`tab-${tabId}`).classList.add('tab-btn-active');

                if (tabId === 'stats') renderStats();
                if (tabId === 'subjects') renderSubjects();
            }

            // --- FUNÇÕES DE DADOS (localStorage) ---
            const loadData = (key, defaultValue) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    console.error(`Erro ao carregar ${key}:`, e);
                    return defaultValue;
                }
            };
            const saveData = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Erro ao salvar ${key}:`, e);
                }
            };

            // --- FUNÇÕES DE MATÉRIAS ---
            function renderSubjects() {
                subjectList.innerHTML = '';
                subjectSelect.innerHTML = '<option value="">Selecione uma matéria...</option>';
                subjects.forEach((subject, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded mb-2';
                    li.innerHTML = `<span>${subject}</span><button data-index="${index}" class="delete-subject-btn text-red-400 hover:text-red-600 text-xl font-bold">×</button>`;
                    subjectList.appendChild(li);
                    
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
            }

            function addSubject() {
                const newSubject = newSubjectInput.value.trim();
                if (newSubject && !subjects.map(s => s.toLowerCase()).includes(newSubject.toLowerCase())) {
                    subjects.push(newSubject);
                    saveData('pomodoroSubjects', subjects);
                    renderSubjects();
                    newSubjectInput.value = '';
                } else if (!newSubject) {
                    alert("O nome da matéria não pode ser vazio.");
                } else {
                    alert("Esta matéria já existe.");
                }
            }

            function deleteSubject(index) {
                subjects.splice(index, 1);
                saveData('pomodoroSubjects', subjects);
                renderSubjects();
            }

            // --- FUNÇÕES DE ESTATÍSTICAS E GRÁFICO ---
            function formatMinutesToHours(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            }

            function renderStats() {
                const last7Days = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setHours(0, 0, 0, 0);
                    d.setDate(d.getDate() - i);
                    last7Days[d.toLocaleDateString('pt-BR')] = 0;
                }

                sessions.forEach(session => {
                    const sessionDate = new Date(session.timestamp);
                    sessionDate.setHours(0, 0, 0, 0);
                    const dateString = sessionDate.toLocaleDateString('pt-BR');
                    if (last7Days[dateString] !== undefined) {
                        last7Days[dateString] += session.duration;
                    }
                });

                if (studyChart) studyChart.destroy();
                studyChart = new Chart(chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(last7Days).map(d => d.substring(0,5)),
                        datasets: [{
                            label: 'Minutos de Foco',
                            data: Object.values(last7Days),
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' } }, x: { ticks: { color: '#9CA3AF' } } },
                        plugins: { legend: { display: false } }
                    }
                });
                
                const aggregated = sessions.reduce((acc, session) => {
                    const key = session.subject.toLowerCase().trim();
                    if (!acc[key]) acc[key] = { duration: 0, subject: session.subject };
                    acc[key].duration += session.duration;
                    return acc;
                }, {});

                statsList.innerHTML = '';
                const sorted = Object.values(aggregated).sort((a,b) => b.duration - a.duration);
                sorted.forEach(({subject, duration}) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 text-sm border-b border-gray-700 last:border-b-0';
                    item.innerHTML = `<span>${subject}</span><span class="font-bold">${formatMinutesToHours(duration)}</span>`;
                    statsList.appendChild(item);
                });
                 if (sorted.length === 0) {
                    statsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum dado registrado.</p>';
                }
            }
            
            function clearAllData() {
                 if (confirm('Tem certeza de que deseja apagar PERMANENTEMENTE todos os dados de estudo? Esta ação não pode ser desfeita.')) {
                    sessions = [];
                    localStorage.removeItem('pomodoroSessions');
                    renderStats();
                }
            }

            // --- FUNÇÕES DO TIMER ---
            const formatTime = (seconds) => `${String(Math.floor(seconds / 60)).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
            const updateDisplay = () => {
                timeDisplay.textContent = formatTime(timeLeft);
                document.title = `${formatTime(timeLeft)} - Sistema de Foco`;
            };

            async function playAlarm() {
                try {
                    await Tone.start();
                    new Tone.Synth().toDestination().triggerAttackRelease("C5", "0.5s");
                } catch(e) { console.error("Erro ao tocar alarme:", e); }
            }

            function startTimer() {
                isRunning = true;
                startPauseBtn.textContent = 'PAUSAR';
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        playAlarm();
                        saveSession(currentSubject, timeSettings.pomodoro);
                        renderStats();
                        switchMode('shortBreak');
                    }
                }, 1000);
            }
            
            function toggleTimer() {
                if(isRunning) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    startPauseBtn.textContent = 'RETOMAR';
                } else {
                    openSubjectModal();
                }
            }

            function switchMode(mode) {
                isRunning = false;
                clearInterval(timerInterval);
                startPauseBtn.textContent = "INICIAR FOCO";
                if(mode === 'pomodoro') {
                    timeLeft = timeSettings.pomodoro * 60;
                } else if (mode === 'shortBreak') {
                    timeLeft = timeSettings.shortBreak * 60;
                } else if (mode === 'longBreak') {
                    timeLeft = timeSettings.longBreak * 60;
                }
                updateDisplay();
            }

            // --- FUNÇÕES DO MODAL ---
            function openSubjectModal() {
                renderSubjects();
                subjectModal.classList.remove('hidden');
                setTimeout(() => subjectModal.classList.remove('opacity-0'), 10);
            }

            function closeSubjectModal() {
                subjectModal.classList.add('opacity-0');
                setTimeout(() => subjectModal.classList.add('hidden'), 300);
            }

            function handleStartFocus() {
                const subject = subjectSelect.value;
                if (subject) {
                    currentSubject = subject;
                    closeSubjectModal();
                    timeLeft = timeSettings.pomodoro * 60;
                    updateDisplay();
                    startTimer();
                } else {
                    alert('Por favor, selecione uma matéria para iniciar o foco.');
                }
            }

            // --- FUNÇÕES DE CONFIGURAÇÕES ---
            function openSettings() {
                pomodoroInput.value = timeSettings.pomodoro;
                shortBreakInput.value = timeSettings.shortBreak;
                longBreakInput.value = timeSettings.longBreak;
                settingsModal.classList.remove('hidden');
                setTimeout(() => settingsModal.classList.remove('opacity-0'), 10);
            }

            function closeSettings() {
                settingsModal.classList.add('opacity-0');
                setTimeout(() => settingsModal.classList.add('hidden'), 300);
            }

            function saveSettings() {
                const newPomodoroTime = parseInt(pomodoroInput.value, 10);
                const newShortBreakTime = parseInt(shortBreakInput.value, 10);
                const newLongBreakTime = parseInt(longBreakInput.value, 10);

                if (newPomodoroTime > 0 && newShortBreakTime > 0 && newLongBreakTime > 0) {
                    timeSettings = {
                        pomodoro: newPomodoroTime,
                        shortBreak: newShortBreakTime,
                        longBreak: newLongBreakTime
                    };
                    saveData('pomodoroTimeSettings', timeSettings);
                    
                    if (!isRunning) {
                       timeLeft = timeSettings.pomodoro * 60;
                       updateDisplay();
                    }
                    closeSettings();
                } else {
                    alert("Por favor, insira valores válidos (maiores que 0).");
                }
            }

            // --- EVENT LISTENERS ---
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.id.replace('tab-', ''))));
            startPauseBtn.addEventListener('click', toggleTimer);
            addSubjectBtn.addEventListener('click', addSubject);
            newSubjectInput.addEventListener('keyup', (e) => e.key === 'Enter' && addSubject());
            subjectList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-subject-btn')) {
                    deleteSubject(e.target.dataset.index);
                }
            });
            startFocusBtn.addEventListener('click', handleStartFocus);
            cancelFocusBtn.addEventListener('click', closeSubjectModal);
            clearStatsBtn.addEventListener('click', clearAllData);
            settingsBtn.addEventListener('click', openSettings);
            saveSettingsBtn.addEventListener('click', saveSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);

            // --- INICIALIZAÇÃO ---
            function init() {
                sessions = loadData('pomodoroSessions', []);
                subjects = loadData('pomodoroSubjects', []);
                timeSettings = loadData('pomodoroTimeSettings', { pomodoro: 25, shortBreak: 5, longBreak: 15 });
                timeLeft = timeSettings.pomodoro * 60;
                updateDisplay();
                renderSubjects();
                switchTab('timer');
            }

            init();
        });
    </script>
</body>
</html>

