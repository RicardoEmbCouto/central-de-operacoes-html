<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cortex - Sistema de Foco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #111827;
        }
        .tab-btn-active {
            border-color: #EF4444;
            color: #F9FAFB;
        }
        .mode-btn-active {
            background-color: #EF4444 !important;
            color: #F9FAFB !important;
        }
        .stats-btn-active {
            background-color: #EF4444;
            color: white;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        #stats-list::-webkit-scrollbar, #subject-list::-webkit-scrollbar {
            width: 8px;
        }
        #stats-list::-webkit-scrollbar-track, #subject-list::-webkit-scrollbar-track {
            background: #1F2937;
        }
        #stats-list::-webkit-scrollbar-thumb, #subject-list::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 text-center relative">
            
            <div class="absolute top-4 right-4">
                <button id="settings-btn" class="text-gray-500 hover:text-white transition-colors p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>

            <div class="mb-8 flex border-b border-gray-700">
                <button id="tab-timer" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 tab-btn-active">Foco</button>
                <button id="tab-stats" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Relatórios</button>
                <button id="tab-subjects" class="tab-btn flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white">Matérias</button>
            </div>

            <div id="timer-view">
                 <div class="bg-gray-900 p-2 rounded-full flex justify-around items-center mb-8">
                    <button id="pomodoro-btn" class="mode-btn mode-btn-active w-full py-2 px-4 rounded-full text-sm font-bold">Foco</button>
                    <button id="short-break-btn" class="mode-btn w-full py-2 px-4 rounded-full text-sm font-bold">Pausa</button>
                    <button id="long-break-btn" class="mode-btn w-full py-2 px-4 rounded-full text-sm font-bold">Descanso</button>
                </div>
                <div class="my-10">
                    <h1 id="time-display" class="text-7xl md:text-8xl font-bold tracking-widest">25:00</h1>
                </div>
                <button id="start-pause-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold text-xl py-4 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                    INICIAR FOCO
                </button>
            </div>

            <div id="stats-view" class="hidden text-left">
                <h2 class="text-xl font-bold mb-4">Relatório de Foco</h2>
                <div class="bg-gray-900 p-2 rounded-full flex justify-around items-center mb-4">
                    <button class="stats-filter-btn stats-btn-active w-full text-xs py-1 px-2 rounded-full" data-filter="today">Hoje</button>
                    <button class="stats-filter-btn w-full text-xs py-1 px-2 rounded-full" data-filter="week">Semana</button>
                    <button class="stats-filter-btn w-full text-xs py-1 px-2 rounded-full" data-filter="month">Mês</button>
                    <button class="stats-filter-btn w-full text-xs py-1 px-2 rounded-full" data-filter="total">Total</button>
                </div>
                <div><canvas id="study-chart"></canvas></div>
                <div id="stats-list" class="mt-4 bg-gray-900 rounded-lg p-4 h-40 overflow-y-auto"></div>
                <div class="text-center mt-4">
                    <button id="clear-stats-btn" class="text-xs text-gray-600 hover:text-red-400 transition-colors">Limpar todos os dados</button>
                </div>
            </div>

            <div id="subjects-view" class="hidden text-left">
                 <h2 class="text-xl font-bold mb-4">Gerenciar Matérias</h2>
                 <div class="flex gap-2 mb-4">
                     <input type="text" id="new-subject-input" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Nova matéria...">
                     <button id="add-subject-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">+</button>
                 </div>
                 <div id="subject-list" class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto"></div>
            </div>

        </div>
        <p class="text-center text-gray-500 mt-6 text-sm">Cortex Productivity System v1.3</p>
    </div>

    <div id="subject-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-white">Definir Foco</h2>
            <div>
                <label for="subject-select" class="block mb-2 text-sm font-medium text-gray-400">Qual será a matéria estudada?</label>
                <select id="subject-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5"></select>
            </div>
            <div class="flex justify-end mt-8">
                <button id="cancel-focus-btn" class="text-gray-400 hover:text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                <button id="start-focus-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Iniciar Foco</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-white">Configurações de Tempo</h2>
            <div class="space-y-4">
                <div>
                    <label for="pomodoro-input" class="block mb-1 text-sm font-medium text-gray-400">Foco (minutos)</label>
                    <input type="number" id="pomodoro-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg" min="1">
                </div>
                <div>
                    <label for="short-break-input" class="block mb-1 text-sm font-medium text-gray-400">Pausa (minutos)</label>
                    <input type="number" id="short-break-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg" min="1">
                </div>
                <div>
                    <label for="long-break-input" class="block mb-1 text-sm font-medium text-gray-400">Descanso (minutos)</label>
                    <input type="number" id="long-break-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg" min="1">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="close-settings-btn" class="text-gray-400 hover:text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="save-settings-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                timeDisplay: document.getElementById('time-display'),
                startPauseBtn: document.getElementById('start-pause-btn'),
                tabs: document.querySelectorAll('.tab-btn'),
                views: {
                    timer: document.getElementById('timer-view'),
                    stats: document.getElementById('stats-view'),
                    subjects: document.getElementById('subjects-view')
                },
                modeButtons: document.querySelectorAll('.mode-btn'),
                subjectModal: document.getElementById('subject-modal'),
                subjectSelect: document.getElementById('subject-select'),
                startFocusBtn: document.getElementById('start-focus-btn'),
                cancelFocusBtn: document.getElementById('cancel-focus-btn'),
                newSubjectInput: document.getElementById('new-subject-input'),
                addSubjectBtn: document.getElementById('add-subject-btn'),
                subjectList: document.getElementById('subject-list'),
                statsList: document.getElementById('stats-list'),
                clearStatsBtn: document.getElementById('clear-stats-btn'),
                chartCanvas: document.getElementById('study-chart'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
                pomodoroInput: document.getElementById('pomodoro-input'),
                shortBreakInput: document.getElementById('short-break-input'),
                longBreakInput: document.getElementById('long-break-input'),
                statsFilterBtns: document.querySelectorAll('.stats-filter-btn')
            };

            let state = {
                timerInterval: null,
                timeLeft: 0,
                currentMode: 'pomodoro',
                isRunning: false,
                pomodoroCycleCount: 0,
                currentSubject: '',
                sessions: [],
                subjects: [],
                studyChart: null,
                timeSettings: { pomodoro: 25, shortBreak: 5, longBreak: 15 }
            };

            const switchTab = (tabId) => {
                Object.values(elements.views).forEach(view => view.classList.add('hidden'));
                elements.tabs.forEach(tab => tab.classList.remove('tab-btn-active'));
                
                elements.views[tabId].classList.remove('hidden');
                document.getElementById(`tab-${tabId}`).classList.add('tab-btn-active');

                if (tabId === 'stats') renderStats('today');
                if (tabId === 'subjects') renderSubjects();
            };

            const loadData = (key, defaultValue) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) { return defaultValue; }
            };
            const saveData = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) { console.error(`Erro ao salvar ${key}:`, e); }
            };

            function renderSubjects() {
                elements.subjectList.innerHTML = '';
                elements.subjectSelect.innerHTML = '<option value="">Selecione uma matéria...</option>';
                state.subjects.forEach((subject, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded mb-2';
                    li.innerHTML = `<span>${subject}</span><button data-index="${index}" class="delete-subject-btn text-red-400 hover:text-red-600 text-xl font-bold">×</button>`;
                    elements.subjectList.appendChild(li);
                    
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    elements.subjectSelect.appendChild(option);
                });
            }

            function addSubject() {
                const newSubject = elements.newSubjectInput.value.trim();
                if (newSubject && !state.subjects.map(s => s.toLowerCase()).includes(newSubject.toLowerCase())) {
                    state.subjects.push(newSubject);
                    saveData('pomodoroSubjects', state.subjects);
                    renderSubjects();
                    elements.newSubjectInput.value = '';
                } else if (!newSubject) {
                    alert("O nome da matéria não pode ser vazio.");
                } else {
                    alert("Esta matéria já existe.");
                }
            }

            function deleteSubject(index) {
                state.subjects.splice(index, 1);
                saveData('pomodoroSubjects', state.subjects);
                renderSubjects();
            }

            const formatMinutesToHours = (minutes) => `${Math.floor(minutes / 60)}h ${minutes % 60}m`;

            function renderStats(filter) {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                
                let filteredSessions;
                switch(filter) {
                    case 'today':
                        filteredSessions = state.sessions.filter(s => new Date(s.timestamp).getTime() >= todayStart);
                        break;
                    case 'week':
                        const firstDayOfWeek = new Date(todayStart);
                        firstDayOfWeek.setDate(new Date(todayStart).getDate() - new Date(todayStart).getDay() + (new Date(todayStart).getDay() === 0 ? -6 : 1) ); // Adjust to Monday
                        filteredSessions = state.sessions.filter(s => new Date(s.timestamp).getTime() >= firstDayOfWeek.getTime());
                        break;
                    case 'month':
                        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                        filteredSessions = state.sessions.filter(s => new Date(s.timestamp).getTime() >= firstDayOfMonth);
                        break;
                    default:
                        filteredSessions = state.sessions;
                }

                const aggregated = filteredSessions.reduce((acc, session) => {
                    const key = session.subject.toLowerCase().trim();
                    if (!acc[key]) acc[key] = { duration: 0, subject: session.subject };
                    acc[key].duration += session.duration;
                    return acc;
                }, {});

                elements.statsFilterBtns.forEach(btn => {
                    btn.classList.remove('stats-btn-active');
                    if(btn.dataset.filter === filter) btn.classList.add('stats-btn-active');
                });

                elements.statsList.innerHTML = '';
                const sorted = Object.values(aggregated).sort((a,b) => b.duration - a.duration);
                sorted.forEach(({subject, duration}) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 text-sm border-b border-gray-700 last:border-b-0';
                    item.innerHTML = `<span>${subject}</span><span class="font-bold">${formatMinutesToHours(duration)}</span>`;
                    elements.statsList.appendChild(item);
                });
                 if (sorted.length === 0) {
                    elements.statsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum dado para este período.</p>';
                }

                const last7Days = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setHours(0, 0, 0, 0);
                    d.setDate(d.getDate() - i);
                    last7Days[d.toLocaleDateString('pt-BR')] = 0;
                }
                state.sessions.forEach(session => {
                    const sessionDate = new Date(session.timestamp);
                    sessionDate.setHours(0, 0, 0, 0);
                    const dateString = sessionDate.toLocaleDateString('pt-BR');
                    if (last7Days[dateString] !== undefined) {
                        last7Days[dateString] += session.duration;
                    }
                });

                if (state.studyChart) state.studyChart.destroy();
                state.studyChart = new Chart(elements.chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(last7Days).map(d => d.substring(0,5)),
                        datasets: [{
                            label: 'Minutos de Foco',
                            data: Object.values(last7Days),
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' } }, x: { ticks: { color: '#9CA3AF' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            function clearAllData() {
                 if (confirm('Tem certeza de que deseja apagar PERMANENTEMENTE todos os dados de estudo? Esta ação não pode ser desfeita.')) {
                    state.sessions = [];
                    saveData('pomodoroSessions', state.sessions);
                    renderStats('today');
                }
            }

            const formatTime = (seconds) => `${String(Math.floor(seconds / 60)).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
            const updateDisplay = () => {
                elements.timeDisplay.textContent = formatTime(state.timeLeft);
                document.title = `${formatTime(state.timeLeft)} - Sistema de Foco`;
            };

            async function playAlarm() {
                try {
                    await Tone.start();
                    new Tone.Synth().toDestination().triggerAttackRelease("C5", "0.5s");
                } catch(e) { console.error("Erro ao tocar alarme:", e); }
            }

            function startTimer() {
                state.isRunning = true;
                elements.startPauseBtn.textContent = 'PAUSAR';
                state.timerInterval = setInterval(() => {
                    state.timeLeft--;
                    updateDisplay();
                    if (state.timeLeft <= 0) {
                        clearInterval(state.timerInterval);
                        playAlarm();
                        if (state.currentMode === 'pomodoro') {
                            saveData('pomodoroSessions', [...state.sessions, { timestamp: new Date().toISOString(), subject: state.currentSubject, duration: state.timeSettings.pomodoro }]);
                            loadDataAndRender();
                            state.pomodoroCycleCount++;
                            switchMode(state.pomodoroCycleCount % 4 === 0 ? 'longBreak' : 'shortBreak');
                        } else {
                            switchMode('pomodoro');
                        }
                    }
                }, 1000);
            }
            
            function toggleTimer() {
                if(state.isRunning) {
                    clearInterval(state.timerInterval);
                    state.isRunning = false;
                    elements.startPauseBtn.textContent = 'RETOMAR';
                } else {
                    if (state.currentMode === 'pomodoro') {
                        openSubjectModal();
                    } else {
                        startTimer();
                    }
                }
            }

            function switchMode(mode) {
                state.currentMode = mode;
                state.timeLeft = state.timeSettings[mode] * 60;
                clearInterval(state.timerInterval);
                state.isRunning = false;
                
                elements.modeButtons.forEach(button => button.classList.remove('mode-btn-active'));
                document.getElementById(`${mode}-btn`).classList.add('mode-btn-active');
                
                if (mode === 'shortBreak' || mode === 'longBreak') {
                    elements.startPauseBtn.textContent = 'INICIAR PAUSA';
                } else {
                    elements.startPauseBtn.textContent = 'INICIAR FOCO';
                }
                updateDisplay();
            }

            function openSubjectModal() {
                renderSubjects();
                elements.subjectModal.classList.remove('hidden');
                setTimeout(() => elements.subjectModal.classList.remove('opacity-0'), 10);
            }

            function closeSubjectModal() {
                elements.subjectModal.classList.add('opacity-0');
                setTimeout(() => elements.subjectModal.classList.add('hidden'), 300);
            }

            function handleStartFocus() {
                const subject = elements.subjectSelect.value;
                if (subject) {
                    state.currentSubject = subject;
                    closeSubjectModal();
                    startTimer();
                } else {
                    alert('Por favor, selecione uma matéria para iniciar o foco.');
                }
            }

            function openSettings() {
                elements.pomodoroInput.value = state.timeSettings.pomodoro;
                elements.shortBreakInput.value = state.timeSettings.shortBreak;
                elements.longBreakInput.value = state.timeSettings.longBreak;
                elements.settingsModal.classList.remove('hidden');
                setTimeout(() => elements.settingsModal.classList.remove('opacity-0'), 10);
            }

            function closeSettings() {
                elements.settingsModal.classList.add('opacity-0');
                setTimeout(() => elements.settingsModal.classList.add('hidden'), 300);
            }

            function saveSettings() {
                const newPomodoroTime = parseInt(elements.pomodoroInput.value, 10);
                const newShortBreakTime = parseInt(elements.shortBreakInput.value, 10);
                const newLongBreakTime = parseInt(elements.longBreakInput.value, 10);

                if (newPomodoroTime > 0 && newShortBreakTime > 0 && newLongBreakTime > 0) {
                    state.timeSettings = {
                        pomodoro: newPomodoroTime,
                        shortBreak: newShortBreakTime,
                        longBreak: newLongBreakTime
                    };
                    saveData('pomodoroTimeSettings', state.timeSettings);
                    
                    if (!state.isRunning) {
                       switchMode(state.currentMode);
                    }
                    closeSettings();
                } else {
                    alert("Por favor, insira valores válidos (maiores que 0).");
                }
            }
            
            function loadDataAndRender() {
                state.sessions = loadData('pomodoroSessions', []);
                state.subjects = loadData('pomodoroSubjects', []);
                state.timeSettings = loadData('pomodoroTimeSettings', { pomodoro: 25, shortBreak: 5, longBreak: 15 });
                state.timeLeft = state.timeSettings.pomodoro * 60;
                updateDisplay();
                renderSubjects();
            }

            elements.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.id.replace('tab-', ''))));
            elements.startPauseBtn.addEventListener('click', toggleTimer);
            elements.addSubjectBtn.addEventListener('click', addSubject);
            elements.newSubjectInput.addEventListener('keyup', (e) => e.key === 'Enter' && addSubject());
            elements.subjectList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-subject-btn')) {
                    deleteSubject(e.target.dataset.index);
                }
            });
            elements.startFocusBtn.addEventListener('click', handleStartFocus);
            elements.cancelFocusBtn.addEventListener('click', closeSubjectModal);
            elements.clearStatsBtn.addEventListener('click', clearAllData);
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            elements.closeSettingsBtn.addEventListener('click', closeSettings);
            elements.statsFilterBtns.forEach(btn => btn.addEventListener('click', () => renderStats(btn.dataset.filter)));

            loadDataAndRender();
            switchTab('timer'); 
        });
    </script>
</body>
</html>

